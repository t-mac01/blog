<!doctype html>
<html lang="en-us">
  <head>
    <title>分布式任务 // Jiao</title>
    <link rel="shortcut icon" href="/favicon.ico" />
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.109.0">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="Jiao" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="/blog/css/main.min.3c3c186cd62e563ad6e2f00a89dbee656ab912d1d46f856b5605dd0232521e2a.css" />

    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="分布式任务"/>
<meta name="twitter:description" content="分布式任务执行 1、每天较定时任务提前1小时生成令牌，保存至redis中
redisTemplate.set(key,value,1,day);
​ 执行定时任务时获取令牌，并移除令牌，value=redisTemplat.opsForValue().getAndSet(key,newValue);
2、分布式锁执行定时任务
​	分布式锁工具类获取锁、检查当天是否有统计过（redis判断），防止服务器时间差重复执行
3、xxl-job
调度中心、执行器解耦
均支持分布式
动态启动、停止任务、修改任务状态
动态扩容
&hellip;
思想：
调度中心负责配置数据库、web的crud、报警邮箱、调度线程池配置、调度中心日志保存
执行器负责填入调度中心的地址，多个以逗号隔开，执行器使用该地址进行‘执行器心跳注册和任务结果回调’，为空关闭注册，执行器appName、注册ip port，执行器日志保存路径及天数
任务通讯流程 1、“调度中心”向“执行器”发送http调度请求: “执行器”中接收请求的服务，实际上是一台内嵌Server，默认端口9999; 2、“执行器”执行任务逻辑； 3、“执行器”http回调“调度中心”调度结果: “调度中心”中接收回调的服务，是针对执行器开放一套API服务; 代码核心逻辑 1、分布式环境保证只有一台实例执行采用数据库的方式：for update
select * from xxl_job_lock where lock_name = &#39;schedule_lock&#39; for update 非spring管理的类获取spring管理的类
@Component public class XxlJobAdminConfig implements InitializingBean { private static XxlJobAdminConfig adminConfig = null; public static XxlJobAdminConfig getAdminConfig() { return adminConfig; } @Override public void afterPropertiesSet() throws Exception { adminConfig = this; } XxlJobScheduler项目启动开始执行init方法，初始化以下内容"/>

    <meta property="og:title" content="分布式任务" />
<meta property="og:description" content="分布式任务执行 1、每天较定时任务提前1小时生成令牌，保存至redis中
redisTemplate.set(key,value,1,day);
​ 执行定时任务时获取令牌，并移除令牌，value=redisTemplat.opsForValue().getAndSet(key,newValue);
2、分布式锁执行定时任务
​	分布式锁工具类获取锁、检查当天是否有统计过（redis判断），防止服务器时间差重复执行
3、xxl-job
调度中心、执行器解耦
均支持分布式
动态启动、停止任务、修改任务状态
动态扩容
&hellip;
思想：
调度中心负责配置数据库、web的crud、报警邮箱、调度线程池配置、调度中心日志保存
执行器负责填入调度中心的地址，多个以逗号隔开，执行器使用该地址进行‘执行器心跳注册和任务结果回调’，为空关闭注册，执行器appName、注册ip port，执行器日志保存路径及天数
任务通讯流程 1、“调度中心”向“执行器”发送http调度请求: “执行器”中接收请求的服务，实际上是一台内嵌Server，默认端口9999; 2、“执行器”执行任务逻辑； 3、“执行器”http回调“调度中心”调度结果: “调度中心”中接收回调的服务，是针对执行器开放一套API服务; 代码核心逻辑 1、分布式环境保证只有一台实例执行采用数据库的方式：for update
select * from xxl_job_lock where lock_name = &#39;schedule_lock&#39; for update 非spring管理的类获取spring管理的类
@Component public class XxlJobAdminConfig implements InitializingBean { private static XxlJobAdminConfig adminConfig = null; public static XxlJobAdminConfig getAdminConfig() { return adminConfig; } @Override public void afterPropertiesSet() throws Exception { adminConfig = this; } XxlJobScheduler项目启动开始执行init方法，初始化以下内容" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://t-mac01.github.io/blog/post/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2023-01-29T23:10:26+08:00" />
<meta property="article:modified_time" content="2023-01-29T23:10:26+08:00" />


  </head>
  <body>
    <header class="app-header">
      <a href="https://t-mac01.github.io/blog/"><img class="app-header-avatar" src="/blog/avatar.jpg" alt="Jiao" /></a>
      <span class="app-header-title">Jiao</span>
      <nav class="app-header-menu">
          <a class="app-header-menu-item" href="/blog/">Home</a>
             - 
          
          <a class="app-header-menu-item" href="/blog/tags/">Tags</a>
             - 
          
          <a class="app-header-menu-item" href="/blog/about/">About</a>
      </nav>
      <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nunc vehicula turpis sit amet elit pretium.</p>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">分布式任务</h1>
      <div class="post-meta">
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Jan 29, 2023
        </div>
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          4 min read
        </div>
      </div>
    </header>
    <div class="post-content">
      <h4 id="分布式任务执行">分布式任务执行</h4>
<p>1、每天较定时任务提前1小时生成令牌，保存至redis中</p>
<p>redisTemplate.set(key,value,1,day);</p>
<p>​     执行定时任务时获取令牌，并移除令牌，value=redisTemplat.opsForValue().getAndSet(key,newValue);</p>
<p>2、分布式锁执行定时任务</p>
<p>​	分布式锁工具类获取锁、检查当天是否有统计过（redis判断），防止服务器时间差重复执行</p>
<p>3、xxl-job</p>
<p>调度中心、执行器解耦</p>
<p>均支持分布式</p>
<p>动态启动、停止任务、修改任务状态</p>
<p>动态扩容</p>
<p>&hellip;</p>
<p>思想：</p>
<p>调度中心负责配置数据库、web的crud、报警邮箱、调度线程池配置、调度中心日志保存</p>
<p>执行器负责填入调度中心的地址，多个以逗号隔开，执行器使用该地址进行‘执行器心跳注册和任务结果回调’，为空关闭注册，执行器appName、注册ip port，执行器日志保存路径及天数</p>
<p><img src="https://www.xuxueli.com/doc/static/xxl-job/images/img_Qohm.png" alt="输入图片说明"></p>
<h4 id="任务通讯流程">任务通讯流程</h4>
<ul>
<li>1、“调度中心”向“执行器”发送http调度请求: “执行器”中接收请求的服务，实际上是一台内嵌Server，默认端口9999;</li>
<li>2、“执行器”执行任务逻辑；</li>
<li>3、“执行器”http回调“调度中心”调度结果: “调度中心”中接收回调的服务，是针对执行器开放一套API服务;</li>
</ul>
<h4 id="代码核心逻辑">代码核心逻辑</h4>
<p>1、分布式环境保证只有一台实例执行采用数据库的方式：for update</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> xxl_job_lock <span style="color:#66d9ef">where</span> lock_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;schedule_lock&#39;</span> <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">update</span>
</span></span></code></pre></div><p>非spring管理的类获取spring管理的类</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Component</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">XxlJobAdminConfig</span> <span style="color:#66d9ef">implements</span> InitializingBean <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> XxlJobAdminConfig adminConfig <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> XxlJobAdminConfig <span style="color:#a6e22e">getAdminConfig</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> adminConfig<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">afterPropertiesSet</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        adminConfig <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span></code></pre></div><p>XxlJobScheduler项目启动开始执行init方法，初始化以下内容</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// init i18n
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>initI18n<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// admin trigger pool start
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>JobTriggerPoolHelper<span style="color:#f92672">.</span><span style="color:#a6e22e">toStart</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// admin registry monitor run
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>JobRegistryHelper<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">().</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// admin fail-monitor run
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>JobFailMonitorHelper<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">().</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// admin lose-monitor run ( depend on JobTriggerPoolHelper )
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>JobCompleteHelper<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">().</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// admin log report start
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>JobLogReportHelper<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">().</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// start-schedule  ( depend on JobTriggerPoolHelper )
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>JobScheduleHelper<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">().</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>logger<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; init xxl-job admin success.&#34;</span><span style="color:#f92672">);</span>
</span></span></code></pre></div><p>同时还提供了destory方法，被容器销毁时调用：DisposableBean</p>
<p>  该接口的作用是：允许在容器销毁该bean的时候获得一次回调。DisposableBean接口也只规定了一个方法：destroy</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">destroy</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// stop-schedule
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    JobScheduleHelper<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">().</span><span style="color:#a6e22e">toStop</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// admin log report stop
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    JobLogReportHelper<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">().</span><span style="color:#a6e22e">toStop</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// admin lose-monitor stop
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    JobCompleteHelper<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">().</span><span style="color:#a6e22e">toStop</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// admin fail-monitor stop
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    JobFailMonitorHelper<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">().</span><span style="color:#a6e22e">toStop</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// admin registry stop
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    JobRegistryHelper<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">().</span><span style="color:#a6e22e">toStop</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// admin trigger pool stop
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    JobTriggerPoolHelper<span style="color:#f92672">.</span><span style="color:#a6e22e">toStop</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>XxlJobScheduler：开启一个线程去扫描即将要执行的定时任务</p>
<p>该线程由变量private volatile boolean scheduleThreadToStop = false;控制</p>
<p>执行处理XxlJobTrigger类实现</p>
<p>这里用到了策略模式，，路由策略保存到数据库中的，得到一个具体的执行器，调用父类的路由方法，该父类是抽象类，子类必须实现该父类的路由方法，由此使用抽象类</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>FIRST<span style="color:#f92672">(</span>I18nUtil<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;jobconf_route_first&#34;</span><span style="color:#f92672">),</span> <span style="color:#66d9ef">new</span> ExecutorRouteFirst<span style="color:#f92672">()),</span>
</span></span><span style="display:flex;"><span>LAST<span style="color:#f92672">(</span>I18nUtil<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;jobconf_route_last&#34;</span><span style="color:#f92672">),</span> <span style="color:#66d9ef">new</span> ExecutorRouteLast<span style="color:#f92672">()),</span>
</span></span><span style="display:flex;"><span>ROUND<span style="color:#f92672">(</span>I18nUtil<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;jobconf_route_round&#34;</span><span style="color:#f92672">),</span> <span style="color:#66d9ef">new</span> ExecutorRouteRound<span style="color:#f92672">()),</span>
</span></span><span style="display:flex;"><span>RANDOM<span style="color:#f92672">(</span>I18nUtil<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;jobconf_route_random&#34;</span><span style="color:#f92672">),</span> <span style="color:#66d9ef">new</span> ExecutorRouteRandom<span style="color:#f92672">()),</span>
</span></span><span style="display:flex;"><span>CONSISTENT_HASH<span style="color:#f92672">(</span>I18nUtil<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;jobconf_route_consistenthash&#34;</span><span style="color:#f92672">),</span> <span style="color:#66d9ef">new</span> ExecutorRouteConsistentHash<span style="color:#f92672">()),</span>
</span></span><span style="display:flex;"><span>LEAST_FREQUENTLY_USED<span style="color:#f92672">(</span>I18nUtil<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;jobconf_route_lfu&#34;</span><span style="color:#f92672">),</span> <span style="color:#66d9ef">new</span> ExecutorRouteLFU<span style="color:#f92672">()),</span>
</span></span><span style="display:flex;"><span>LEAST_RECENTLY_USED<span style="color:#f92672">(</span>I18nUtil<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;jobconf_route_lru&#34;</span><span style="color:#f92672">),</span> <span style="color:#66d9ef">new</span> ExecutorRouteLRU<span style="color:#f92672">()),</span>
</span></span><span style="display:flex;"><span>FAILOVER<span style="color:#f92672">(</span>I18nUtil<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;jobconf_route_failover&#34;</span><span style="color:#f92672">),</span> <span style="color:#66d9ef">new</span> ExecutorRouteFailover<span style="color:#f92672">()),</span>
</span></span><span style="display:flex;"><span>BUSYOVER<span style="color:#f92672">(</span>I18nUtil<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;jobconf_route_busyover&#34;</span><span style="color:#f92672">),</span> <span style="color:#66d9ef">new</span> ExecutorRouteBusyover<span style="color:#f92672">()),</span>
</span></span><span style="display:flex;"><span>SHARDING_BROADCAST<span style="color:#f92672">(</span>I18nUtil<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;jobconf_route_shard&#34;</span><span style="color:#f92672">),</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ExecutorRouteStrategyEnum<span style="color:#f92672">(</span>String title<span style="color:#f92672">,</span> ExecutorRouter router<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">title</span> <span style="color:#f92672">=</span> title<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">router</span> <span style="color:#f92672">=</span> router<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> String title<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> ExecutorRouter router<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">getTitle</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> title<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> ExecutorRouter <span style="color:#a6e22e">getRouter</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> router<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>路由后得到执行的机器地址，缓存该机器的map,key为地址，value为执行器，执行器为一个接口，ExecutorBizClient执行器实现了http调用，调用执行core包的核心处理，</p>
<p>core包实现一个内嵌服务，该内嵌服务由第三方引用注册xxlJobExecutor为bean时开始初始化</p>
<p>第三方引用</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> XxlJobSpringExecutor <span style="color:#a6e22e">xxlJobExecutor</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    logger<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job config init.&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    XxlJobSpringExecutor xxlJobSpringExecutor <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> XxlJobSpringExecutor<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    xxlJobSpringExecutor<span style="color:#f92672">.</span><span style="color:#a6e22e">setAdminAddresses</span><span style="color:#f92672">(</span>adminAddresses<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    xxlJobSpringExecutor<span style="color:#f92672">.</span><span style="color:#a6e22e">setAppname</span><span style="color:#f92672">(</span>appname<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    xxlJobSpringExecutor<span style="color:#f92672">.</span><span style="color:#a6e22e">setAddress</span><span style="color:#f92672">(</span>address<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    xxlJobSpringExecutor<span style="color:#f92672">.</span><span style="color:#a6e22e">setIp</span><span style="color:#f92672">(</span>ip<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    xxlJobSpringExecutor<span style="color:#f92672">.</span><span style="color:#a6e22e">setPort</span><span style="color:#f92672">(</span>port<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    xxlJobSpringExecutor<span style="color:#f92672">.</span><span style="color:#a6e22e">setAccessToken</span><span style="color:#f92672">(</span>accessToken<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    xxlJobSpringExecutor<span style="color:#f92672">.</span><span style="color:#a6e22e">setLogPath</span><span style="color:#f92672">(</span>logPath<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    xxlJobSpringExecutor<span style="color:#f92672">.</span><span style="color:#a6e22e">setLogRetentionDays</span><span style="color:#f92672">(</span>logRetentionDays<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> xxlJobSpringExecutor<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>开始初始化start、同时注册所有的xxlJob，缓存到map中key为xxlJob的名字，value为JobHandler</p>
<pre tabindex="0"><code>public class XxlJobSpringExecutor extends XxlJobExecutor implements ApplicationContextAware, SmartInitializingSingleton, DisposableBean {

    // start
    @Override
    public void afterSingletonsInstantiated() {

        // init JobHandler Repository
        /*initJobHandlerRepository(applicationContext);*/

        // init JobHandler Repository (for method)
        initJobHandlerMethodRepository(applicationContext);

        // refresh GlueFactory
        GlueFactory.refreshInstance(1);

        // super start
        try {
            super.start();
        } catch (Exception e) {
            throw new RuntimeException(e);
        }
    }
</code></pre><p>开启内嵌服务</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">start</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// init logpath
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    XxlJobFileAppender<span style="color:#f92672">.</span><span style="color:#a6e22e">initLogPath</span><span style="color:#f92672">(</span>logPath<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// init invoker, admin-client
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    initAdminBizList<span style="color:#f92672">(</span>adminAddresses<span style="color:#f92672">,</span> accessToken<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// init JobLogFileCleanThread
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    JobLogFileCleanThread<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">().</span><span style="color:#a6e22e">start</span><span style="color:#f92672">(</span>logRetentionDays<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// init TriggerCallbackThread
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    TriggerCallbackThread<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">().</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// init executor-server
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    initEmbedServer<span style="color:#f92672">(</span>address<span style="color:#f92672">,</span> ip<span style="color:#f92672">,</span> port<span style="color:#f92672">,</span> appname<span style="color:#f92672">,</span> accessToken<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>内嵌按服务采用netty实现</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">start</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> String address<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> port<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> String appname<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> String accessToken<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    executorBiz <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ExecutorBizImpl<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    thread <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Thread<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Runnable<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// param
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            EventLoopGroup bossGroup <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> NioEventLoopGroup<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            EventLoopGroup workerGroup <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> NioEventLoopGroup<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            ThreadPoolExecutor bizThreadPool <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ThreadPoolExecutor<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#ae81ff">0</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#ae81ff">200</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#ae81ff">60L</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                    TimeUnit<span style="color:#f92672">.</span><span style="color:#a6e22e">SECONDS</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">new</span> LinkedBlockingQueue<span style="color:#f92672">&lt;</span>Runnable<span style="color:#f92672">&gt;(</span><span style="color:#ae81ff">2000</span><span style="color:#f92672">),</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">new</span> ThreadFactory<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">public</span> Thread <span style="color:#a6e22e">newThread</span><span style="color:#f92672">(</span>Runnable r<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Thread<span style="color:#f92672">(</span>r<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;xxl-job, EmbedServer bizThreadPool-&#34;</span> <span style="color:#f92672">+</span> r<span style="color:#f92672">.</span><span style="color:#a6e22e">hashCode</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">},</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">new</span> RejectedExecutionHandler<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">rejectedExecution</span><span style="color:#f92672">(</span>Runnable r<span style="color:#f92672">,</span> ThreadPoolExecutor executor<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;xxl-job, EmbedServer bizThreadPool is EXHAUSTED!&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">});</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// start server
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                ServerBootstrap bootstrap <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ServerBootstrap<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                bootstrap<span style="color:#f92672">.</span><span style="color:#a6e22e">group</span><span style="color:#f92672">(</span>bossGroup<span style="color:#f92672">,</span> workerGroup<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">.</span><span style="color:#a6e22e">channel</span><span style="color:#f92672">(</span>NioServerSocketChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">.</span><span style="color:#a6e22e">childHandler</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> ChannelInitializer<span style="color:#f92672">&lt;</span>SocketChannel<span style="color:#f92672">&gt;()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">initChannel</span><span style="color:#f92672">(</span>SocketChannel channel<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                                channel<span style="color:#f92672">.</span><span style="color:#a6e22e">pipeline</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>                                        <span style="color:#f92672">.</span><span style="color:#a6e22e">addLast</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> IdleStateHandler<span style="color:#f92672">(</span><span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">30</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> TimeUnit<span style="color:#f92672">.</span><span style="color:#a6e22e">SECONDS</span><span style="color:#f92672">))</span>  <span style="color:#75715e">// beat 3N, close if idle
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                                        <span style="color:#f92672">.</span><span style="color:#a6e22e">addLast</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> HttpServerCodec<span style="color:#f92672">())</span>
</span></span><span style="display:flex;"><span>                                        <span style="color:#f92672">.</span><span style="color:#a6e22e">addLast</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> HttpObjectAggregator<span style="color:#f92672">(</span><span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1024</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1024</span><span style="color:#f92672">))</span>  <span style="color:#75715e">// merge request &amp; reponse to FULL
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                                        <span style="color:#f92672">.</span><span style="color:#a6e22e">addLast</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> EmbedHttpServerHandler<span style="color:#f92672">(</span>executorBiz<span style="color:#f92672">,</span> accessToken<span style="color:#f92672">,</span> bizThreadPool<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">})</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">.</span><span style="color:#a6e22e">childOption</span><span style="color:#f92672">(</span>ChannelOption<span style="color:#f92672">.</span><span style="color:#a6e22e">SO_KEEPALIVE</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// bind
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                ChannelFuture future <span style="color:#f92672">=</span> bootstrap<span style="color:#f92672">.</span><span style="color:#a6e22e">bind</span><span style="color:#f92672">(</span>port<span style="color:#f92672">).</span><span style="color:#a6e22e">sync</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                logger<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job remoting server start success, nettype = {}, port = {}&#34;</span><span style="color:#f92672">,</span> EmbedServer<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> port<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// start registry
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                startRegistry<span style="color:#f92672">(</span>appname<span style="color:#f92672">,</span> address<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// wait util stop
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                future<span style="color:#f92672">.</span><span style="color:#a6e22e">channel</span><span style="color:#f92672">().</span><span style="color:#a6e22e">closeFuture</span><span style="color:#f92672">().</span><span style="color:#a6e22e">sync</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>InterruptedException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                logger<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job remoting server stop.&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                logger<span style="color:#f92672">.</span><span style="color:#a6e22e">error</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job remoting server error.&#34;</span><span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// stop
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    workerGroup<span style="color:#f92672">.</span><span style="color:#a6e22e">shutdownGracefully</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                    bossGroup<span style="color:#f92672">.</span><span style="color:#a6e22e">shutdownGracefully</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    logger<span style="color:#f92672">.</span><span style="color:#a6e22e">error</span><span style="color:#f92672">(</span>e<span style="color:#f92672">.</span><span style="color:#a6e22e">getMessage</span><span style="color:#f92672">(),</span> e<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">});</span>
</span></span><span style="display:flex;"><span>    thread<span style="color:#f92672">.</span><span style="color:#a6e22e">setDaemon</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>    <span style="color:#75715e">// daemon, service jvm, user thread leave &gt;&gt;&gt; daemon leave &gt;&gt;&gt; jvm leave
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    thread<span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>注册执行器</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">startRegistry</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> String appname<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> String address<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// start registry
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    ExecutorRegistryThread<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">().</span><span style="color:#a6e22e">start</span><span style="color:#f92672">(</span>appname<span style="color:#f92672">,</span> address<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>在netty中加入handler实现接收刚刚路由过来的信息</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">switch</span> <span style="color:#f92672">(</span>uri<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;/beat&#34;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> executorBiz<span style="color:#f92672">.</span><span style="color:#a6e22e">beat</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;/idleBeat&#34;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        IdleBeatParam idleBeatParam <span style="color:#f92672">=</span> GsonTool<span style="color:#f92672">.</span><span style="color:#a6e22e">fromJson</span><span style="color:#f92672">(</span>requestData<span style="color:#f92672">,</span> IdleBeatParam<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> executorBiz<span style="color:#f92672">.</span><span style="color:#a6e22e">idleBeat</span><span style="color:#f92672">(</span>idleBeatParam<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;/run&#34;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        TriggerParam triggerParam <span style="color:#f92672">=</span> GsonTool<span style="color:#f92672">.</span><span style="color:#a6e22e">fromJson</span><span style="color:#f92672">(</span>requestData<span style="color:#f92672">,</span> TriggerParam<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> executorBiz<span style="color:#f92672">.</span><span style="color:#a6e22e">run</span><span style="color:#f92672">(</span>triggerParam<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;/kill&#34;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        KillParam killParam <span style="color:#f92672">=</span> GsonTool<span style="color:#f92672">.</span><span style="color:#a6e22e">fromJson</span><span style="color:#f92672">(</span>requestData<span style="color:#f92672">,</span> KillParam<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> executorBiz<span style="color:#f92672">.</span><span style="color:#a6e22e">kill</span><span style="color:#f92672">(</span>killParam<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;/log&#34;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        LogParam logParam <span style="color:#f92672">=</span> GsonTool<span style="color:#f92672">.</span><span style="color:#a6e22e">fromJson</span><span style="color:#f92672">(</span>requestData<span style="color:#f92672">,</span> LogParam<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> executorBiz<span style="color:#f92672">.</span><span style="color:#a6e22e">log</span><span style="color:#f92672">(</span>logParam<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> ReturnT<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;(</span>ReturnT<span style="color:#f92672">.</span><span style="color:#a6e22e">FAIL_CODE</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;invalid request, uri-mapping(&#34;</span> <span style="color:#f92672">+</span> uri <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;) not found.&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>通过jobId得到jobhandler的实例放到blockqueue队列中</p>
<p>开启线程从队列中拉数据开始执行，执行jobhandler的execute方法，该方法实现xxlJob里的定时任务逻辑</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MethodJobHandler</span> <span style="color:#66d9ef">extends</span> IJobHandler <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> Object target<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> Method method<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> Method initMethod<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> Method destroyMethod<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">MethodJobHandler</span><span style="color:#f92672">(</span>Object target<span style="color:#f92672">,</span> Method method<span style="color:#f92672">,</span> Method initMethod<span style="color:#f92672">,</span> Method destroyMethod<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">target</span> <span style="color:#f92672">=</span> target<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">method</span> <span style="color:#f92672">=</span> method<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">initMethod</span> <span style="color:#f92672">=</span> initMethod<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">destroyMethod</span> <span style="color:#f92672">=</span> destroyMethod<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">execute</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        Class<span style="color:#f92672">&lt;?&gt;[]</span> paramTypes <span style="color:#f92672">=</span> method<span style="color:#f92672">.</span><span style="color:#a6e22e">getParameterTypes</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>paramTypes<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            method<span style="color:#f92672">.</span><span style="color:#a6e22e">invoke</span><span style="color:#f92672">(</span>target<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> Object<span style="color:#f92672">[</span>paramTypes<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">]);</span>       <span style="color:#75715e">// method-param can not be primitive-types
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            method<span style="color:#f92672">.</span><span style="color:#a6e22e">invoke</span><span style="color:#f92672">(</span>target<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">}</span>
</span></span></code></pre></div>
    </div>
    <div class="post-footer">
      
    </div>
  </article>

    </main>
  </body>
</html>
